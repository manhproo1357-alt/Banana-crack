-- Ngăn chặn chạy trùng lặp
if getgenv().SystemExecuted then return end
getgenv().SystemExecuted = true

local player = game.Players.LocalPlayer
local runService = game:GetService("RunService")
local coreGui = game:GetService("CoreGui")

-- Biến kiểm soát
getgenv().ScriptEnabled = true

-- 1. Hàm hiện Popup thông báo (Chỉ hiện 1 lần lúc đầu)
local function ShowStartPopup()
    local sg = Instance.new("ScreenGui", coreGui)
    local frame = Instance.new("Frame", sg)
    frame.Size = UDim2.new(0, 260, 0, 70)
    frame.Position = UDim2.new(0.5, -130, 0.15, 0)
    frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    frame.BorderSizePixel = 2
    
    local label = Instance.new("TextLabel", frame)
    label.Size = UDim2.new(1, 0, 1, 0)
    label.Text = "Hệ thống đang khởi động...\n[ Vui lòng chờ 5 giây ]"
    label.TextColor3 = Color3.fromRGB(255, 200, 0)
    label.Font = Enum.Font.SourceSansBold
    label.TextSize = 16
    label.BackgroundTransparency = 1
    
    game:GetService("Debris"):AddItem(sg, 5)
end

-- 2. Chức năng NoClip (Xuyên tường)
local noclipConnection
noclipConnection = runService.Stepped:Connect(function()
    if getgenv().ScriptEnabled and player.Character then
        for _, part in pairs(player.Character:GetDescendants()) do
            if part:IsA("BasePart") and part.CanCollide then
                part.CanCollide = false
            end
        end
    end
end)

-- 3. Nút Tắt Toàn Bộ Menu
local mainGui = Instance.new("ScreenGui", coreGui)
local closeBtn = Instance.new("TextButton", mainGui)
closeBtn.Size = UDim2.new(0, 130, 0, 45)
closeBtn.Position = UDim2.new(0, 15, 0.45, 0)
closeBtn.Text = "TẮT SCRIPT"
closeBtn.BackgroundColor3 = Color3.fromRGB(170, 0, 0)
closeBtn.TextColor3 = Color3.new(1, 1, 1)
closeBtn.Font = Enum.Font.SourceSansBold
closeBtn.TextSize = 16
closeBtn.Draggable = true

closeBtn.MouseButton1Click:Connect(function()
    getgenv().ScriptEnabled = false
    getgenv().SystemExecuted = false
    if noclipConnection then noclipConnection:Disconnect() end
    mainGui:Destroy()
    warn("Toàn bộ chức năng đã được dừng.")
end)

-- 4. Hàm chạy script PANDA (Chạy khi khởi động và khi hồi sinh)
local function RunPanda()
    if getgenv().ScriptEnabled then
        pcall(function()
            loadstring(game:HttpGet("https://pandadevelopment.net/virtual/file/e9c206fd76482ee2"))()
        end)
    end
end

-- 5. Logic thực thi chính
ShowStartPopup()

-- BƯỚC 1: Chạy Panda ngay lập tức
RunPanda()

-- BƯỚC 2: Đợi 5 giây rồi chạy Banana (Chỉ chạy 1 lần này)
task.delay(5, function()
    if getgenv().ScriptEnabled then
        pcall(function()
            loadstring(game:HttpGet("https://raw.githubusercontent.com/kimprobloxdz/Banana-Free/refs/heads/main/Protected_5609200582002947.lua.txt"))()
        end)
    end
end)

-- 6. Xử lý hồi sinh (Chỉ chạy lại Panda)
player.CharacterAdded:Connect(function()
    if getgenv().ScriptEnabled then
        task.wait(1.5) -- Đợi nhân vật xuất hiện hẳn
        RunPanda()
    end
end)
